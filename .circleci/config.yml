version: 2.1
 
orbs:
  gcp-cli: circleci/gcp-cli@3.1.1
 
executors:
  ubuntu:
    docker:
      - image: cimg/base:stable
 
jobs:
  packer-build:
    executor: ubuntu
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_TOKEN: root
      GOOGLE_WORKLOAD_IDENTITY_PROVIDER: "projects/516216943908/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
      GOOGLE_SERVICE_ACCOUNT_EMAIL: "github-ci-sa@packer-automation-483407.iam.gserviceaccount.com"
 
    steps:
      - checkout
 
      # ---- GCP Auth ----
      - gcp-cli/install
      - gcp-cli/setup
 
      - run:
          name: Validate GCP Auth
          command: gcloud auth list
 
      # ---- Python & Ansible ----
      - run:
          name: Install Python & Ansible
          command: |
            sudo apt update
            sudo apt install -y python3-pip
            pip3 install ansible passlib
 
      # ---- Install Packer & Vault ----
      - run:
          name: Install Packer & Vault
          command: |
            sudo apt-get update
            sudo apt-get install -y curl unzip gnupg lsb-release jq
            curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
            echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
              | sudo tee /etc/apt/sources.list.d/hashicorp.list
            sudo apt-get update
            sudo apt-get install -y packer vault
 
      # ---- Vault ----
      - run:
          name: Start Vault
          command: |
            vault server -dev -dev-root-token-id=root > vault.log 2>&1 &
            sleep 5
 
      - run:
          name: Configure Vault Secrets
          command: |
            vault kv put secret/packer/ansible \
              admin_password="${ADMIN_PASSWORD}" \
              user1_password="${USER1_PASSWORD}"
 
      - run:
          name: Create Packer Vars
          command: |
            ADMIN_PASSWORD=$(vault kv get -field=admin_password secret/packer/ansible)
            USER1_PASSWORD=$(vault kv get -field=user1_password secret/packer/ansible)
 
            cat \<<EOF > packer_template_gcp/secrets.auto.pkrvars.hcl
            admin_password = "${ADMIN_PASSWORD}"
            user1_password = "${USER1_PASSWORD}"
            EOF
 
      # ---- Packer ----
      - run:
          name: Packer Init
          command: packer init packer_template_gcp
 
      - run:
          name: Packer Validate
          command: packer validate packer_template_gcp
 
      - run:
          name: Packer Build
          command: |
            packer build packer_template_gcp | tee packer.log
            IMAGE_NAME=$(grep -oP "project: \Kpacker-[^ ]+" packer.log | tail -1)
            echo "$IMAGE_NAME" > image_name.txt
 
      - persist_to_workspace:
          root: .
          paths:
            - image_name.txt
 
  terraform-deploy:
    executor: ubuntu
    environment:
      GOOGLE_WORKLOAD_IDENTITY_PROVIDER: "projects/516216943908/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
      GOOGLE_SERVICE_ACCOUNT_EMAIL: "github-ci-sa@packer-automation-483407.iam.gserviceaccount.com"
 
    steps:
      - checkout
      - attach_workspace:
          at: .
 
      - gcp-cli/install
      - gcp-cli/setup
 
      - run:
          name: Install Terraform
          command: |
            sudo apt update
            sudo apt install -y terraform
 
      - run:
          name: Generate SSH Key
          command: |
            mkdir -p ~/.ssh
            ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N ""
            cat ~/.ssh/id_ed25519.pub > ssh_public_key.txt
 
      - persist_to_workspace:
          root: .
          paths:
            - ssh_public_key.txt
 
      - run:
          name: Terraform Init
          command: |
            cd terraform-gcp
            terraform init
 
      - run:
          name: Terraform Apply
          command: |
            IMAGE_NAME=$(cat image_name.txt)
            SSH_PUBLIC_KEY=$(cat ssh_public_key.txt)
 
            cd terraform-gcp
            terraform apply \
              -var="image_name=$IMAGE_NAME" \
              -var="ssh_public_key=$SSH_PUBLIC_KEY" \
              -auto-approve
 
      - run:
          name: Validate VM Users
          command: |
            chmod +x .vscode/scripts/verify_users.sh
            ./.vscode/scripts/verify_users.sh
 
  terraform-destroy:
    executor: ubuntu
    environment:
      GOOGLE_WORKLOAD_IDENTITY_PROVIDER: "projects/516216943908/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
      GOOGLE_SERVICE_ACCOUNT_EMAIL: "github-ci-sa@packer-automation-483407.iam.gserviceaccount.com"
 
    steps:
      - checkout
      - attach_workspace:
          at: .
 
      - gcp-cli/install
      - gcp-cli/setup
 
      - run:
          name: Install Terraform
          command: |
            sudo apt update
            sudo apt install -y terraform
 
      - run:
          name: Wait 5 Minutes
          command: sleep 300
 
      - run:
          name: Terraform Destroy
          command: |
            IMAGE_NAME=$(cat image_name.txt)
            SSH_PUBLIC_KEY=$(cat ssh_public_key.txt)
 
            cd terraform-gcp
            terraform destroy \
              -var="image_name=$IMAGE_NAME" \
              -var="ssh_public_key=$SSH_PUBLIC_KEY" \
              -auto-approve
 
workflows:
  packer-terraform:
    jobs:
      - packer-build
      - terraform-deploy:
          requires:
            - packer-build
      - terraform-destroy:
          requires:
            - terraform-deploy
## End of file
